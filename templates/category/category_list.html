{% extends 'layouts/dashboard_base.html' %}
{% load custom_template_tags %}
{% load static %}

{% block title %}
    {% if is_expense %}
        Expense Categories
    {% else %}
        Earning Categories
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/category_list.css' %}">
<link rel="stylesheet" href="{% static 'css/view_modal.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>
        {% if is_expense == "True" %}
            Expense Categories
        {% else %}
            Earning Categories
        {% endif %}
    </h1>

    <div class="d-flex justify-content-end mb-3">
        <button id="btnAddCategory" class="btn btn-primary"
                data-url="{% url 'add_new_category' is_expense %}">
            Add New
        </button>
    </div>

    <div class="table-container">
        <table class="table table-striped">
            <thead>
                <tr>
                    {% for field in form %}
                    {% if field.name != 'is_expense' %}
                        <th>{{ field.label }}</th>
                    {% endif %}
                    {% endfor %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr data-id="{{ category.id }}">
                    {% for field in form %}
                        {% if field.name != 'is_expense' %}
                        <td data-label="{{ field.label }}">
                            {{ category|get_field_value:field.name|truncatechars:20 }}
                        </td>
                        {% endif %}
                    {% endfor %}
                    <td>
                        <a href="#" class="btn-view btn btn-info btn-sm"
                           data-url="{% url 'category_view' category.id %}">View</a>
                        <a href="#" class="btn-edit btn btn-warning btn-sm">Edit</a>
                        <a href="#" class="btn-delete btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ form|length|add:'1' }}" class="text-center">No categories found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Add New Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="addCategoryModalBody">
        <!-- Form will be loaded here dynamically -->
        <div class="text-center p-3">
            <div class="spinner-border text-primary" role="status" id="loadingSpinner" style="display:none;">
              <span class="visually-hidden">Loading...</span>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const addBtn = document.getElementById("btnAddCategory");
    const modalBody = document.getElementById("addCategoryModalBody");
    const modal = new bootstrap.Modal(document.getElementById("addCategoryModal"));
    const spinner = document.getElementById("loadingSpinner");

    addBtn.addEventListener("click", function() {
        const url = this.getAttribute("data-url");
        spinner.style.display = "block";
        modalBody.innerHTML = "";
        modal.show();

        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                spinner.style.display = "none";

                // Add submit listener for AJAX form
                const form = modalBody.querySelector("form");
                if (form) {
                    form.addEventListener("submit", function(e) {
                        e.preventDefault();
                        const formData = new FormData(form);
                        fetch(form.action, {
                            method: "POST",
                            body: formData,
                            headers: { "X-Requested-With": "XMLHttpRequest" }
                        })
                        .then(resp => resp.json())
                        .then(data => {
                            if (data.success) {
                                location.reload(); // Reload to show new category
                            } else {
                                modalBody.innerHTML = data.form_html; // Reload form with errors
                            }
                        });
                    });
                }
            })
            .catch(() => {
                spinner.style.display = "none";
                modalBody.innerHTML = "<p class='text-danger text-center'>Failed to load form.</p>";
            });
    });
});
</script>
{% endblock %}
